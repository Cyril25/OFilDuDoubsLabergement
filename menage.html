<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'Fil du Doubs - Disponibilités</title>
    <link rel="stylesheet" href="styles.css">

    <!-- FullCalendar CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }
    </style>
</head>
<body>
    <div id="calendar"></div>

    <script>
        // Initialisation du calendrier vide
        console.log('Initialisation du calendrier vide');
        $('#calendar').fullCalendar({
            locale: 'fr',
            height: 'auto',
            events: [] // Calendrier vide au départ
        });

        // Fonction pour récupérer le fichier iCalendar
        console.log('Début de la récupération du fichier iCalendar');
        fetch('https://airbnb-ical-proxy.cyril-samson41.workers.dev/')
            .then(response => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        console.log('Réponse reçue du serveur iCalendar');
                        resolve(response.text());
                    }, 1); // Simuler un délai de x secondes (en msec)
                });
            })
            .then(data => {
                console.log('Données iCalendar récupérées avec succès');
                const events = parseICS(data);
                console.log('Événements parsés:', events);
                updateCalendar(events); // Mettre à jour le calendrier avec les événements
            })
            .catch(error => {
                console.error('Erreur lors de la récupération du fichier iCal:', error);
            });

        // Fonction pour parser le fichier iCalendar (.ics)
        function parseICS(icsData) {
            console.log('Début du parsing du fichier iCalendar');
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);

            if (eventsRaw) {
                console.log(`${eventsRaw.length} événements trouvés dans le fichier iCalendar`);
                eventsRaw.forEach(event => {
                    const eventDetails = {};
                    const summaryPattern = /SUMMARY:(.*)/;
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;
                    const descriptionPattern = /DESCRIPTION:(.*)/;

                    const summary = event.match(summaryPattern);
                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);
                    const description = event.match(descriptionPattern);

                    if (summary && startDate && endDate) {
                        eventDetails.title = 'Indisponible'; // On force le titre à "Indisponible"
                        eventDetails.start = formatDate(startDate[1]);
                        eventDetails.end = formatDate(endDate[1]);
                        eventDetails.description = description ? description[1] : 'Pas de description';
                        console.log('Événement parsé:', eventDetails);
                        console.log(`Date de début: ${eventDetails.start}, Date de fin: ${eventDetails.end}`);
                        events.push(eventDetails);
                    }
                });
            } else {
                console.log('Aucun événement trouvé dans le fichier iCalendar');
            }
            return events;
        }

        // Fonction pour formater les dates au format ISO (YYYY-MM-DD)
        function formatDate(dateString) {
            console.log('Formatage de la date:', dateString);
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        // Fonction pour mettre à jour le calendrier avec les événements
        function updateCalendar(events) {
            console.log('Mise à jour du calendrier avec les événements:', events);
            $('#calendar').fullCalendar('addEventSource', events); // Ajouter les événements au calendrier existant
            console.log('Calendrier mis à jour avec succès');
        }
    </script>
</body>
</html>