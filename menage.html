<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="robots" content="noindex, nofollow">

    <title>Planning Ménage - O'Fil du Doubs</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>

    <style>
        /* Ajustement car il n'y a pas de menu fixe sur cette page */
        body { padding-top: 20px; }

        #calendar {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 10px;
        }

        #cleaning-slots-list {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #cleaning-slots-list h2 {
            text-align: center;
            color: var(--primary-color);
            font-family: var(--font-title);
        }

        #legend {
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        #legend p {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        #legend span.couleur {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
        }

        #legend span.libelle {
            font-weight: bold;
            color: #333;
        }

        #cleaning-slots {
            list-style-type: none;
            padding: 0;
        }

        #cleaning-slots li {
            margin: 10px 0;
            padding: 15px;
            background-color: #e6f7ff;
            border-left: 5px solid #91d5ff;
            border-radius: 4px;
            color: #0050b3;
            font-size: 16px;
            text-align: left;
            font-family: var(--font-body);
        }

        #cleaning-slots li.urgent {
            background-color: #fff1f0;
            border-left-color: #ff4d4f;
            color: #a8071a;
            font-weight: bold;
        }

        #cleaning-slots li.weekend {
            background-color: #fafafa;
            border-left-color: #d9d9d9;
            color: #595959;
            font-style: italic;
        }

        /* FullCalendar Overrides */
        .fc-event.same-day {
            background-color: #ff4d4f !important;
            border-color: #ff4d4f !important;
            color: #fff !important;
        }

        .fc-event.standard-slot {
            background-color: #91d5ff !important;
            border-color: #91d5ff !important;
            color: #0050b3 !important;
        }

        .fc-event.weekend-slot {
            background-color: #d9d9d9 !important;
            border-color: #d9d9d9 !important;
            color: #8c8c8c !important;
        }
        
        /* Masquer l'heure dans le calendrier */
        .fc-time { display: none; }
    </style>
</head>
<body>

    <header style="text-align: center; margin-bottom: 20px;">
        <h1 style="font-family: var(--font-title); color: var(--primary-color);">Planning Ménage</h1>
    </header>

    <div id="cleaning-slots-list">
        <h2>Prochains Créneaux</h2>
        <div id="legend">
            <p>
                <span class="couleur" style="background-color: #ffcccc; border: 1px solid #ff4d4f;"></span>
                <span class="libelle">Date fixe (Urgent)</span>
            </p>
            <p>
                <span class="couleur" style="background-color: #e6f7ff; border: 1px solid #91d5ff;"></span>
                <span class="libelle">Standard (Flexible)</span>
            </p>
            <p>
                <span class="couleur" style="background-color: #f0f0f0; border: 1px solid #d9d9d9;"></span>
                <span class="libelle">Weekend</span>
            </p>
        </div>
        <ul id="cleaning-slots"></ul>
    </div>

    <div id="calendar"></div>

    <script>
        // Fonction utilitaire pour avoir 'YYYY-MM-DD' en date LOCALE
        function getLocalISODate(date = new Date()) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const todayISO = getLocalISODate();
        
        // Dates manuelles et exclusions (A mettre à jour ici si besoin)
        const allManualCleaningDates = ['2024-11-01', '2025-12-29', '2026-02-19'];
        const allExcludedCleaningDates = ['2024-10-30', '2025-12-27'];

        const manualCleaningDates = allManualCleaningDates.filter(date => date >= todayISO);
        const excludedCleaningDates = allExcludedCleaningDates.filter(date => date >= todayISO);

        // Initialisation du calendrier
        $('#calendar').fullCalendar({
            locale: 'fr',
            height: 'auto',
            events: [] 
        });

        // Récupération iCal
        fetch('https://airbnb-ical-proxy.cyril-samson41.workers.dev/')
            .then(response => response.text())
            .then(data => {
                const events = parseICS(data);
                const cleaningSlots = calculateCleaningSlots(events);
                updateCalendar(cleaningSlots);
                updateCleaningSlotsList(cleaningSlots);
            })
            .catch(error => {
                console.error('Erreur iCal:', error);
            });

        // --- FONCTIONS DE CALCUL (Ton code original) ---
        
        function parseICS(icsData) {
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);
            const today = new Date();
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(today.getMonth() + 6);

            if (eventsRaw) {
                eventsRaw.forEach(event => {
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;
                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);

                    if (startDate && endDate) {
                        const start = new Date(formatDate(startDate[1]));
                        const end = new Date(formatDate(endDate[1]));
                        if (start > sixMonthsLater || end < today) return;

                        events.push({
                            start: formatDate(startDate[1]) + 'T17:00:00',
                            end: formatDate(endDate[1]) + 'T11:00:00'
                        });
                    }
                });
                events.sort((a, b) => new Date(a.start) - new Date(b.start));

                if (events.length > 0) {
                    const first = events[0];
                    const now = new Date();
                    const firstStart = new Date(first.start);
                    if (now < firstStart) {
                        events._preFirstCleaningSlot = {
                            start: now.toISOString(),
                            end: firstStart.toISOString(),
                            title: "Créneau ménage",
                            displayText:"Créneau ménage"
                        };
                    }
                }
            }
            return events;
        }

        function calculateCleaningSlots(events) {
            let initialSlots = [];
            if (events._preFirstCleaningSlot) initialSlots.push(events._preFirstCleaningSlot);

            for (let i = 0; i < events.length - 1; i++) {
                const currentEventEnd = new Date(events[i].end);
                const nextEventStart = new Date(events[i + 1].start);
                if (currentEventEnd < nextEventStart) {
                    initialSlots.push({
                        title: `Créneau ménage`,
                        start: currentEventEnd.toISOString(),
                        end: nextEventStart.toISOString(),
                        displayText: `Créneau ménage`
                    });
                }
            }

            const allowedCleaningDays = new Set();
            const dayTimeMap = new Map();

            for (const slot of initialSlots) {
                const datesInSlot = enumerateDatesInRange(slot.start, slot.end);
                const startDate = new Date(slot.start).toISOString().split('T')[0];
                const endDate = new Date(slot.end).toISOString().split('T')[0];

                for (const date of datesInSlot) {
                    allowedCleaningDays.add(date);
                    if (date === startDate) {
                        let times = dayTimeMap.get(date) || { start: null, end: null };
                        times.start = slot.start;
                        dayTimeMap.set(date, times);
                    }
                    if (date === endDate) {
                        let times = dayTimeMap.get(date) || { start: null, end: null };
                        times.end = slot.end;
                        dayTimeMap.set(date, times);
                    }
                }
            }

            for (const excludeDate of excludedCleaningDates) allowedCleaningDays.delete(excludeDate);
            for (const manualDate of manualCleaningDates) {
                allowedCleaningDays.add(manualDate);
                if (!dayTimeMap.has(manualDate)) {
                    dayTimeMap.set(manualDate, { 
                        start: new Date(manualDate + 'T11:00:00Z').toISOString(), 
                        end: new Date(manualDate + 'T17:00:00Z').toISOString() 
                    });
                }
            }

            if (allowedCleaningDays.size === 0) return [];

            const sortedDates = Array.from(allowedCleaningDays).sort();
            const finalSlots = [];
            let currentSlot = null;

            for (const date of sortedDates) {
                const expectedNextDate = currentSlot ? addDaysToISODate(currentSlot._endDateOnly, 1) : null;
                if (currentSlot && date === expectedNextDate) {
                    const endTime = (dayTimeMap.get(date) && dayTimeMap.get(date).end) ? dayTimeMap.get(date).end : new Date(date + 'T17:00:00Z').toISOString();
                    currentSlot.end = endTime;
                    currentSlot._endDateOnly = date;
                } else {
                    if (currentSlot) finalSlots.push(currentSlot);
                    const startTime = (dayTimeMap.get(date) && dayTimeMap.get(date).start) ? dayTimeMap.get(date).start : new Date(date + 'T11:00:00Z').toISOString();
                    const endTime = (dayTimeMap.get(date) && dayTimeMap.get(date).end) ? dayTimeMap.get(date).end : new Date(date + 'T17:00:00Z').toISOString();
                    currentSlot = {
                        title: 'Créneau ménage',
                        start: startTime,
                        end: endTime,
                        displayText: 'Créneau ménage',
                        _startDateOnly: date,
                        _endDateOnly: date
                    };
                }
            }
            if (currentSlot) finalSlots.push(currentSlot);
            return finalSlots;
        }

        function updateCalendar(cleaningSlots) {
            $('#calendar').fullCalendar('addEventSource', cleaningSlots.map(slot => {
                const slotStart = new Date(slot.start);
                const slotEnd = new Date(slot.end);
                const isSameDay = slotStart.toDateString() === slotEnd.toDateString();
                const isWeekendSlot = slotStart.getDay() === 6 && slotStart.getHours() >= 11 && slotEnd.getDay() === 0 && slotEnd.getHours() <= 17 && slotStart.toDateString() !== slotEnd.toDateString();

                return {
                    ...slot,
                    className: isSameDay ? 'same-day' : isWeekendSlot ? 'weekend-slot' : 'standard-slot'
                };
            }));
        }

        function updateCleaningSlotsList(cleaningSlots) {
            const listElement = document.getElementById('cleaning-slots');
            if (!listElement) return;
            listElement.innerHTML = '';

            cleaningSlots.forEach((slot, idx) => {
                const listItem = document.createElement('li');
                const slotStart = new Date(slot.start);
                const slotEnd = new Date(slot.end);
                const now = new Date();

                if (idx === 0 && slotStart <= now) {
                    listItem.innerHTML = `<span>Entre maintenant et le ${slotEnd.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} à ${slotEnd.getHours().toString().padStart(2, '0')}h</span>`;
                } else if (slotStart.toDateString() === slotEnd.toDateString()) {
                    listItem.classList.add('urgent');
                    listItem.innerHTML = `<span>Le ${slotStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} entre 11h et 17h</span>`;
                } else {
                    listItem.innerHTML = `<span>Entre ${slotStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 11h et ${slotEnd.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 17h</span>`;
                }

                if (slotStart.getDay() === 6 && slotStart.getHours() >= 11 && slotEnd.getDay() === 0 && slotEnd.getHours() <= 17 && slotStart.toDateString() !== slotEnd.toDateString()) {
                    listItem.classList.add('weekend');
                }
                listElement.appendChild(listItem);
            });
        }

        function formatDate(dateString) {
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        function addDaysToISODate(isoDate, days) {
            const date = new Date(isoDate); 
            date.setUTCDate(date.getUTCDate() + days);
            return date.toISOString().split('T')[0];
        }

        function enumerateDatesInRange(startISOString, endISOString) {
            const dates = new Set();
            let currentISO = new Date(startISOString).toISOString().split('T')[0];
            const endDate = new Date(endISOString).toISOString().split('T')[0];
            const endObj = new Date(endDate);
            while (new Date(currentISO) <= endObj) {
                dates.add(currentISO);
                currentISO = addDaysToISODate(currentISO, 1);
            }
            return Array.from(dates);
        }
    </script>
</body>
</html>