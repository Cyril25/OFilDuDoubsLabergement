<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'Fil du Doubs - Disponibilités</title>
    <link rel="stylesheet" href="styles.css">

    <!-- FullCalendar CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }

        #cleaning-slots-list {
            max-width: 900px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #cleaning-slots-list h2 {
            text-align: center;
            color: #333;
        }

        #legend {
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
        }

        #legend p {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        #legend span {
            display: inline-block;
            width: 15px; /* Keep 15px for color box */
            height: 15px;
            margin-right: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        #legend p span + span {
            font-size: 16px; /* Increased font size for label and description */
            font-weight: bold; /* Make it bold for better readability */
            color: #333; /* Adjust text color */
        }

        #cleaning-slots {
            list-style-type: none;
            padding: 0;
        }

        #cleaning-slots li {
            margin: 10px 0;
            padding: 10px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 5px;
            color: #0050b3;
            font-size: 16px;
            font-family: Arial, sans-serif;
            text-align: left;
        }

        #cleaning-slots li span {
            font-weight: bold;
            color: #000;
        }

        #cleaning-slots li.urgent {
            background-color: #ffcccc; /* Red background */
            border: 1px solid #ff4d4f; /* Red border */
            color: #a8071a; /* Dark red text */
            font-weight: bold;
        }

        #cleaning-slots li.weekend {
            background-color: #f0f0f0; /* Light gray background */
            border: 1px solid #d9d9d9; /* Light gray border */
            color: #8c8c8c; /* Gray text */
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="cleaning-slots-list">
        <h2>Créneaux de ménage</h2>
        <div id="legend">
            <p>
                <span style="background-color: #ffcccc; border: 1px solid #ff4d4f;"></span>
                <span>Urgent : Ménage à effectuer le même jour.</span>
            </p>
            <p>
                <span style="background-color: #f0f0f0; border: 1px solid #d9d9d9;"></span>
                <span>Weekend : Créneau pendant un weekend.</span>
            </p>
            <p>
                <span style="background-color: #e6f7ff; border: 1px solid #91d5ff;"></span>
                <span>Standard : Créneau classique.</span>
            </p>
        </div>
        <ul id="cleaning-slots"></ul>
    </div>
    <div id="calendar"></div>

    <script>
        // Initialisation du calendrier vide
        console.log("Étape 0 : Initialisation du calendrier");
        $('#calendar').fullCalendar({
            locale: 'fr',
            height: 'auto',
            events: [] // Calendrier vide au départ
        });

        // Étape 1 : Récupérer et parser le fichier iCalendar
        console.log("Étape 1 : Récupération du fichier iCalendar");
        fetch('https://airbnb-ical-proxy.cyril-samson41.workers.dev/')
            .then(response => response.text())
            .then(data => {
                console.log("Étape 1 : Fichier iCalendar récupéré avec succès");
                const events = parseICS(data);
                console.log("Étape 1 : Fichier iCalendar parsé avec succès", events);
                const cleaningSlots = calculateCleaningSlots(events);
                console.log("Étape 2 : Créneaux de ménage calculés", cleaningSlots);
                updateCalendar(cleaningSlots);
                console.log("Étape 3 : Calendrier mis à jour avec les créneaux de ménage");
                updateCleaningSlotsList(cleaningSlots);
                console.log("Étape 4 : Liste des créneaux de ménage mise à jour");
            })
            .catch(error => {
                console.error('Erreur lors de la récupération du fichier iCal:', error);
            });

        // Fonction pour parser le fichier iCalendar (.ics)
        function parseICS(icsData) {
            console.log("Parsing du fichier iCalendar...");
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);

            if (eventsRaw) {
                eventsRaw.forEach(event => {
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;

                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);

                    if (startDate && endDate) {
                        events.push({
                            title: 'Ménage',
                            start: formatDate(startDate[1]) + 'T17:00:00', // Arrivée à 17h
                            end: formatDate(endDate[1]) + 'T11:00:00' // Départ à 11h
                        });
                    }
                });

                // Trier les événements par date de début
                events.sort((a, b) => new Date(a.start) - new Date(b.start));
            }

            console.log("Parsing terminé", events);
            return events;
        }

        // Étape 2 : Calculer les créneaux de ménage
        function calculateCleaningSlots(events) {
            console.log("Calcul des créneaux de ménage...");
            const cleaningSlots = [];

            for (let i = 0; i < events.length - 1; i++) {
                const currentEventEnd = new Date(events[i].end);
                const nextEventStart = new Date(events[i + 1].start);

                currentEventEnd.setHours(11, 0, 0, 0); // Départ à 11h
                nextEventStart.setHours(17, 0, 0, 0); // Arrivée à 17h

                if (currentEventEnd < nextEventStart) {
                    cleaningSlots.push({
                        title: `Entre ${currentEventEnd.toLocaleDateString('fr-FR', { weekday: 'long' })} ${currentEventEnd.toLocaleDateString('fr-FR')} (11h) et ${nextEventStart.toLocaleDateString('fr-FR', { weekday: 'long' })} ${nextEventStart.toLocaleDateString('fr-FR')} (17h)`,
                        start: currentEventEnd.toISOString(),
                        end: nextEventStart.toISOString(),
                        // displayText: `Entre le ${currentEventEnd.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} à 11h et le ${nextEventStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} à 17h`
                    });
                }
            }

            console.log("Créneaux de ménage calculés", cleaningSlots);
            return cleaningSlots;
        }

        // Étape 3 : Mettre à jour le calendrier avec les créneaux de ménage
        function updateCalendar(cleaningSlots) {
            console.log("Mise à jour du calendrier...");
            $('#calendar').fullCalendar('addEventSource', cleaningSlots);
            console.log("Calendrier mis à jour");
        }

        // Étape 4 : Mettre à jour la liste des créneaux de ménage
        function updateCleaningSlotsList(cleaningSlots) {
            console.log("Mise à jour de la liste des créneaux de ménage...");
            const listElement = document.getElementById('cleaning-slots');
            if (!listElement) {
                console.error("L'élément avec l'ID 'cleaning-slots' est introuvable dans le DOM.");
                return;
            }
            listElement.innerHTML = ''; // Réinitialiser la liste

            cleaningSlots.forEach(slot => {
                const listItem = document.createElement('li');
                const slotStart = new Date(slot.start);
                const slotEnd = new Date(slot.end);

                // Ajouter la classe 'urgent' si le ménage doit se faire un jour précis
                if (slotStart.toDateString() === slotEnd.toDateString()) {
                    listItem.classList.add('urgent');
                    listItem.innerHTML = `<span>Le ${slotStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} entre 11h et 17h</span>`;
                } else {
                    // Modifier le libellé pour les créneaux normaux et weekend
                    listItem.innerHTML = `<span>Entre ${slotStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 11h et ${slotEnd.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 17h</span>`;
                }

                // Ajouter la classe 'weekend' si le créneau est entièrement entre samedi 11h et dimanche 17h
                if (
                    slotStart.getDay() === 6 && slotStart.getHours() >= 11 && // Saturday 11h or later
                    slotEnd.getDay() === 0 && slotEnd.getHours() <= 17        // Sunday 17h or earlier
                ) {
                    listItem.classList.add('weekend');
                }

                listElement.appendChild(listItem);
            });

            console.log("Liste des créneaux de ménage mise à jour");
        }

        // Fonction utilitaire pour formater les dates au format ISO (YYYY-MM-DD)
        function formatDate(dateString) {
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html>