<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'Fil du Doubs - Disponibilités</title>
    <link rel="stylesheet" href="styles.css">

    <!-- FullCalendar CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }

        #cleaning-slots-list {
            max-width: 900px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #cleaning-slots-list h2 {
            text-align: center;
            color: #333;
        }

        #cleaning-slots {
            list-style-type: none;
            padding: 0;
        }

        #cleaning-slots li {
            margin: 10px 0;
            padding: 10px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 5px;
            color: #0050b3;
            font-size: 16px;
            font-family: Arial, sans-serif;
            text-align: left;
        }

        #cleaning-slots li span {
            font-weight: bold;
            color: #000;
        }
    </style>
</head>
<body>
    <div id="cleaning-slots-list">
        <h2>Créneaux de ménage</h2>
        <ul id="cleaning-slots"></ul>
    </div>
    <div id="calendar"></div>

    <script>
        // Initialisation du calendrier vide
        console.log("Étape 0 : Initialisation du calendrier");
        $('#calendar').fullCalendar({
            locale: 'fr',
            height: 'auto',
            events: [] // Calendrier vide au départ
        });

        // Étape 1 : Récupérer et parser le fichier iCalendar
        console.log("Étape 1 : Récupération du fichier iCalendar");
        fetch('https://airbnb-ical-proxy.cyril-samson41.workers.dev/')
            .then(response => response.text())
            .then(data => {
                console.log("Étape 1 : Fichier iCalendar récupéré avec succès");
                const events = parseICS(data);
                console.log("Étape 1 : Fichier iCalendar parsé avec succès", events);
                const cleaningSlots = calculateCleaningSlots(events);
                console.log("Étape 2 : Créneaux de ménage calculés", cleaningSlots);
                updateCalendar(cleaningSlots);
                console.log("Étape 3 : Calendrier mis à jour avec les créneaux de ménage");
                updateCleaningSlotsList(cleaningSlots);
                console.log("Étape 4 : Liste des créneaux de ménage mise à jour");
            })
            .catch(error => {
                console.error('Erreur lors de la récupération du fichier iCal:', error);
            });

        // Fonction pour parser le fichier iCalendar (.ics)
        function parseICS(icsData) {
            console.log("Parsing du fichier iCalendar...");
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);

            if (eventsRaw) {
                eventsRaw.forEach(event => {
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;

                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);

                    if (startDate && endDate) {
                        events.push({
                            start: formatDate(startDate[1]) + 'T17:00:00', // Arrivée à 17h
                            end: formatDate(endDate[1]) + 'T11:00:00' // Départ à 11h
                        });
                    }
                });

                // Trier les événements par date de début
                events.sort((a, b) => new Date(a.start) - new Date(b.start));
            }

            console.log("Parsing terminé", events);
            return events;
        }

        // Étape 2 : Calculer les créneaux de ménage
        function calculateCleaningSlots(events) {
            console.log("Calcul des créneaux de ménage...");
            const cleaningSlots = [];

            for (let i = 0; i < events.length - 1; i++) {
                const currentEventEnd = new Date(events[i].end);
                const nextEventStart = new Date(events[i + 1].start);

                currentEventEnd.setHours(11, 0, 0, 0); // Départ à 11h
                nextEventStart.setHours(17, 0, 0, 0); // Arrivée à 17h

                if (currentEventEnd < nextEventStart) {
                    cleaningSlots.push({
                        title: 'Ménage', // Forcer le titre à "Indisponible"
                        start: currentEventEnd.toISOString(),
                        end: nextEventStart.toISOString(),
                        displayText: `Entre le ${currentEventEnd.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} à 11h et le ${nextEventStart.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} à 17h`
                    });
                }
            }

            console.log("Créneaux de ménage calculés", cleaningSlots);
            return cleaningSlots;
        }

        // Étape 3 : Mettre à jour le calendrier avec les créneaux de ménage
        function updateCalendar(cleaningSlots) {
            console.log("Mise à jour du calendrier...");
            $('#calendar').fullCalendar('addEventSource', cleaningSlots);
            console.log("Calendrier mis à jour");
        }

        // Étape 4 : Mettre à jour la liste des créneaux de ménage
        function updateCleaningSlotsList(cleaningSlots) {
            console.log("Mise à jour de la liste des créneaux de ménage...");
            const listElement = document.getElementById('cleaning-slots');
            if (!listElement) {
                console.error("L'élément avec l'ID 'cleaning-slots' est introuvable dans le DOM.");
                return;
            }
            listElement.innerHTML = ''; // Réinitialiser la liste

            cleaningSlots.forEach(slot => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>${slot.title}</span>`;
                listElement.appendChild(listItem);
            });

            console.log("Liste des créneaux de ménage mise à jour");
        }

        // Fonction utilitaire pour formater les dates au format ISO (YYYY-MM-DD)
        function formatDate(dateString) {
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html>