<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'Fil du Doubs - Disponibilités</title>
    <link rel="stylesheet" href="styles.css">

    <!-- FullCalendar CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }
    </style>
</head>
<body>
    <div id="calendar"></div>

    <script>
        // Initialisation du calendrier vide
        $('#calendar').fullCalendar({
            locale: 'fr',
            height: 'auto',
            events: [] // Calendrier vide au départ
        });

        // Fonction pour récupérer le fichier iCalendar
        fetch('https://airbnb-ical-proxy.cyril-samson41.workers.dev/')
            .then(response => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(response.text());
                    }, 1); // Simuler un délai de x secondes (en msec)
                });
            })
            .then(data => {
                const events = parseICS(data);
                updateCalendar(events); // Mettre à jour le calendrier avec les événements
            })
            .catch(error => {
                console.error('Erreur lors de la récupération du fichier iCal:', error);
            });

        // Fonction pour parser le fichier iCalendar (.ics)
        function parseICS(icsData) {
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);

            if (eventsRaw) {
                eventsRaw.forEach(event => {
                    const eventDetails = {};
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;

                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);

                    if (startDate && endDate) {
                        eventDetails.start = formatDate(startDate[1]);
                        eventDetails.end = formatDate(endDate[1]);
                        events.push(eventDetails);
                    }
                });

                // Trier les événements par date de début
                events.sort((a, b) => new Date(a.start) - new Date(b.start));

                // Afficher les événements triés dans les logs
                events.forEach(event => {
                    console.log(`Date d'arrivée des touristes (à 17h): ${event.start}, Date de départ des touristes (à 11h): ${event.end}`);
                });
            }

            // Calculer les créneaux disponibles pour le ménage
            const cleaningSlots = [];

            for (let i = 0; i < events.length - 1; i++) {
                const currentEventEnd = new Date(events[i].end);
                const nextEventStart = new Date(events[i + 1].start);

                // Ajouter les heures spécifiques pour le ménage
                currentEventEnd.setHours(11, 0, 0, 0); // Départ à 11h
                nextEventStart.setHours(17, 0, 0, 0); // Arrivée à 17h

                if (currentEventEnd < nextEventStart) {
                    cleaningSlots.push({
                        title: `Test`, // Titre temporaire pour les créneaux
                        start: currentEventEnd.toISOString(),
                        end: nextEventStart.toISOString()
                    });
                }
            }

            // Ajouter les créneaux disponibles au calendrier
            cleaningSlots.forEach(slot => {
                events.push(slot);
            });

            return events;
        }

        // Fonction pour formater les dates au format ISO (YYYY-MM-DD)
        function formatDate(dateString) {
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        // Fonction pour mettre à jour le calendrier avec les créneaux de ménage uniquement
        function updateCalendar(cleaningSlots) {
            $('#calendar').fullCalendar('addEventSource', cleaningSlots); // Ajouter uniquement les créneaux de ménage au calendrier
        }
    </script>
</body>
</html>