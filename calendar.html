<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Calendrier Airbnb</title>
    
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
        <!-- FullCalendar CSS -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet">
    
        <!-- Moment.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    
        <!-- FullCalendar JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/fr.js"></script>
    </head>
<body>
    <h1>Calendrier des réservations</h1>
    <div id="calendar"></div> <!-- Le calendrier sera affiché ici -->

    <script>
        // Fonction pour récupérer le fichier iCalendar
        fetch('https://ical-proxy-node.onrender.com/ical')
            .then(response => response.text())
            .then(data => {
                const events = parseICS(data);
                initializeCalendar(events);
            })
            .catch(error => console.error('Erreur lors de la récupération du fichier iCal:', error));

        // Fonction pour parser le fichier iCalendar (.ics)
        function parseICS(icsData) {
            const events = [];
            const eventPattern = /BEGIN:VEVENT[\s\S]+?END:VEVENT/g;
            const eventsRaw = icsData.match(eventPattern);

            if (eventsRaw) {
                eventsRaw.forEach(event => {
                    const eventDetails = {};
                    const summaryPattern = /SUMMARY:(.*)/;
                    const datePatternStart = /DTSTART;VALUE=DATE:(\d{8})/;
                    const datePatternEnd = /DTEND;VALUE=DATE:(\d{8})/;
                    const descriptionPattern = /DESCRIPTION:(.*)/;

                    const summary = event.match(summaryPattern);
                    const startDate = event.match(datePatternStart);
                    const endDate = event.match(datePatternEnd);
                    const description = event.match(descriptionPattern);

                    if (summary && startDate && endDate) {
                        eventDetails.title = summary[1];
                        eventDetails.start = formatDate(startDate[1]);
                        eventDetails.end = formatDate(endDate[1]);
                        eventDetails.description = description ? description[1] : 'Pas de description';
                        events.push(eventDetails);
                    }
                });
            }
            return events;
        }

        // Fonction pour formater les dates au format ISO (YYYY-MM-DD)
        function formatDate(dateString) {
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        // Fonction pour initialiser le calendrier avec FullCalendar
        function initializeCalendar(events) {
            $('#calendar').fullCalendar({
                locale: 'fr',
                events: events.map(event => ({
                    title: event.title,
                    start: event.start,
                    end: event.end,
                    description: event.description
                }))
            });
        }
    </script>
</body>
</html>